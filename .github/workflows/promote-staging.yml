name: Promote Dev Release to Staging

on:
  workflow_dispatch:
    inputs:
      devReleaseTag:
        description: 'Which dev release to promote? (Example: dev-123)'
        required: true
        default: 'dev-1'
        type: string

permissions:
  contents: read
  id-token: write

jobs:
  validate-and-promote:
    runs-on: ubuntu-latest
    environment: staging  # Requires manual approval in GitHub Environments
    
    steps:
      - uses: actions/checkout@v4
        with:
          ref: main
          fetch-depth: 0
      
      - name: Validate Release Tag
        id: validate
        run: |
          TAG="${{ github.event.inputs.devReleaseTag }}"
          
          # Check if tag exists
          if ! git rev-parse "$TAG" >/dev/null 2>&1; then
            echo "âŒ Error: Tag '$TAG' does not exist"
            echo "Available dev releases:"
            git tag -l 'dev-*' | tail -5
            exit 1
          fi
          
          # Ensure it's a dev release
          if [[ ! "$TAG" =~ ^dev- ]]; then
            echo "âŒ Error: Only dev releases (starting with 'dev-') can be promoted"
            exit 1
          fi

          # Extract version for staging (remove 'dev-' prefix)
          STABLE_VERSION="${TAG#dev-}"
          echo "stable_version=${STABLE_VERSION}" >> $GITHUB_OUTPUT
          echo "release_tag=${TAG}" >> $GITHUB_OUTPUT
          echo "âœ… Validated release tag: ${TAG}"

      - name: Download deploy metadata from dev release
        shell: bash
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          mkdir -p build-results
          gh release download "${{ steps.validate.outputs.release_tag }}" \
            --repo "${{ github.repository }}" \
            --pattern "deploy-metadata.json" \
            --dir build-results

      - name: Read image ref
        id: meta
        shell: bash
        run: |
          IMAGE_REF=$(python -c "import json; print(json.load(open('build-results/deploy-metadata.json'))['imageRef'])")
          echo "image_ref=$IMAGE_REF" >> $GITHUB_OUTPUT

      - name: Display Promotion Context
        run: |
          echo "========================================"
          echo "PROMOTION TO STAGING"
          echo "========================================"
          echo ""
          echo "Promoting: ${{ steps.validate.outputs.release_tag }}"
          echo "As version: ${{ steps.validate.outputs.stable_version }}"
          echo ""
          echo "ðŸ“‹ Review before proceeding:"
          echo "1. CHANGELOG.md - See what changed"
          echo "2. build-results/last-dev-build.md - See test results"
          echo "3. Verify the release exists in container registry"
          echo ""
          echo "ðŸ“¦ This workflow will:"
          echo "   - Tag the release as ${{ steps.validate.outputs.stable_version }}"
          echo "   - Deploy to staging namespace"
          echo "   - Run smoke tests"
          echo "   - Create a stable release candidate if successful"
          echo "========================================"

      - name: Trivy Image Scan
        uses: aquasecurity/trivy-action@0.33.1
        with:
          image-ref: ${{ steps.meta.outputs.image_ref }}
          severity: CRITICAL,HIGH
          exit-code: 1

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_TO_ASSUME }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: Update kubeconfig
        shell: bash
        run: |
          aws eks update-kubeconfig --name "${{ secrets.EKS_CLUSTER_NAME }}" --region "${{ secrets.AWS_REGION }}"

      - name: Setup Helm
        uses: azure/setup-helm@v4

      - name: Deploy to staging with Helm
        shell: bash
        run: |
          helm upgrade --install main-app ./helm/main-app \
            --namespace staging \
            --create-namespace \
            --set image.ref='${{ steps.meta.outputs.image_ref }}'

      - name: Publish promotion summary
        shell: bash
        run: |
          cat <<EOF >> $GITHUB_STEP_SUMMARY
          # Staging Promotion

          **Dev Release:** ${{ steps.validate.outputs.release_tag }}
          **Staging Version:** ${{ steps.validate.outputs.stable_version }}
          **Image:** ${{ steps.meta.outputs.image_ref }}
          **Namespace:** staging
          EOF