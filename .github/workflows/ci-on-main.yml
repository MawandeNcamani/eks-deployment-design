name: CI on Main

on:
  push:
    branches: [ main ]

permissions:
  contents: write
  security-events: write
  issues: write

jobs:
  prepare:
    name: ðŸ§± Prepare
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

  security-scan-fs:
    name: ðŸ” FS Scan
    runs-on: ubuntu-latest
    needs: prepare
    steps:
      - uses: actions/checkout@v4
      - name: Trivy FS Scan
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: fs
          scan-ref: .
          exit-code: 0

  build-and-push:
    name: ðŸ³ Build & Push Docker Image
    runs-on: ubuntu-latest
    needs: security-scan-fs
    steps:
      - uses: actions/checkout@v4

      - name: Build image
        run: |
          docker build -t example/app:${{ github.sha }} .

  scan-image:
    name: ðŸ›¡ Image Scan
    runs-on: ubuntu-latest
    needs: build-and-push
    if: success()
    steps:
      - name: Trivy Image Scan
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: example/app:${{ github.sha }}
          exit-code: 0

  deploy-dev:
    name: ðŸš€ Deploy Dev
    runs-on: ubuntu-latest
    needs: scan-image
    if: success()
    steps:
      - name: Deploy placeholder
        run: echo "Deploying to dev..."

  generate-report:
    name: ðŸ“ Generate CI Report
    runs-on: ubuntu-latest
    needs:
      - prepare
      - security-scan-fs
      - build-and-push
      - scan-image
      - deploy-dev
    if: always()

    steps:
      - uses: actions/checkout@v4
        with: 
          token: ${{ secrets.PAT_TOKEN }}

      - name: Determine workflow status
        id: status
        run: |
          STATUS="success"
          FAILURE_REASON=""

          if [[ "${{ needs.build-and-push.result }}" == "failure" ]]; then
            STATUS="failure"
            FAILURE_REASON="Docker image build failed. Check Dockerfile or build context."
          elif [[ "${{ needs.security-scan-fs.result }}" == "failure" ]]; then
            STATUS="failure"
            FAILURE_REASON="Filesystem security scan failed due to vulnerabilities."
          elif [[ "${{ needs.scan-image.result }}" == "failure" ]]; then
            STATUS="failure"
            FAILURE_REASON="Container image scan failed due to detected vulnerabilities."
          elif [[ "${{ needs.deploy-dev.result }}" == "failure" ]]; then
            STATUS="failure"
            FAILURE_REASON="Deployment to dev environment failed."
          fi

          echo "status=$STATUS" >> $GITHUB_OUTPUT
          echo "reason=$FAILURE_REASON" >> $GITHUB_OUTPUT

      - name: Create report
        run: |
          mkdir -p ci-reports
          cat <<EOF > ci-reports/ci
