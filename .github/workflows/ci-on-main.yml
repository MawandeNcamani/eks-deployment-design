name: CI on Main - Deploy to Dev

on:
  push:
    branches:
      - main

concurrency:
  group: deploy-dev-${{ github.ref }}
  cancel-in-progress: false

env:
  AWS_REGION: us-east-1
  CLUSTER_NAME: platform-eks-cluster
  NAMESPACE: dev
  HELM_TIMEOUT: 10m

jobs:
  # ------------------------------------------------------------
  # 1. Checkout + Tag
  # ------------------------------------------------------------
  prepare:
    name: üè∑Ô∏è Prepare Build Metadata
    runs-on: ubuntu-latest
    outputs:
      image_tag: ${{ steps.tag.outputs.tag }}

    steps:
      - uses: actions/checkout@v4

      - name: Generate Image Tag
        id: tag
        run: |
          echo "tag=dev-${GITHUB_SHA::7}" >> $GITHUB_OUTPUT

  # ------------------------------------------------------------
  # 2. Security Scan (Repo / Dockerfiles)
  # ------------------------------------------------------------
  security-scan-fs:
    name: üîê Security Scan (Filesystem)
    runs-on: ubuntu-latest
    needs: prepare

    steps:
      - uses: actions/checkout@v4

      - name: Trivy FS Scan
        uses: aquasecurity/trivy-action@0.24.0
        with:
          scan-type: fs
          severity: HIGH,CRITICAL
          ignore-unfixed: true
          exit-code: 1

  # ------------------------------------------------------------
  # 3. Build Images
  # ------------------------------------------------------------
  build-images:
    name: üèóÔ∏è Build Docker Images
    runs-on: ubuntu-latest
    needs: security-scan-fs

    steps:
      - uses: actions/checkout@v4

      - name: Build Main App Image
        run: |
          docker build \
            -t main:${{ needs.prepare.outputs.image_tag }} \
            ./main

      - name: Build Microservice Image
        run: |
          docker build \
            -t micro:${{ needs.prepare.outputs.image_tag }} \
            ./microservice

  # ------------------------------------------------------------
  # 4. Image Security Scan
  # ------------------------------------------------------------
  security-scan-images:
    name: üîê Security Scan (Images)
    runs-on: ubuntu-latest
    needs: build-images

    steps:
      - name: Scan Main App Image
        uses: aquasecurity/trivy-action@0.24.0
        with:
          image-ref: main:${{ needs.prepare.outputs.image_tag }}
          severity: HIGH,CRITICAL
          ignore-unfixed: true
          exit-code: 1

      - name: Scan Microservice Image
        uses: aquasecurity/trivy-action@0.24.0
        with:
          image-ref: micro:${{ needs.prepare.outputs.image_tag }}
          severity: HIGH,CRITICAL
          ignore-unfixed: true
          exit-code: 1

  # ------------------------------------------------------------
  # 5. Deploy to EKS (REAL)
  # ------------------------------------------------------------
  deploy-dev:
    name: üöÄ Deploy to Dev
    runs-on: ubuntu-latest
    needs: security-scan-images

    steps:
      - uses: actions/checkout@v4

      - name: Configure AWS Credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::<ACCOUNT_ID>:role/github-actions-eks-deployer
          aws-region: $AWS_REGION

      - name: Configure kubeconfig
        run: |
          aws eks update-kubeconfig \
            --name $CLUSTER_NAME \
            --region $AWS_REGION

      - name: Deploy Main App
        run: |
          helm upgrade --install main-app ./helm/main-app \
            --namespace $NAMESPACE \
            --create-namespace \
            --set image.tag=${{ needs.prepare.outputs.image_tag }} \
            --wait \
            --timeout $HELM_TIMEOUT

      - name: Deploy Microservice
        run: |
          helm upgrade --install microservice ./helm/microservice \
            --namespace $NAMESPACE \
            --set image.tag=${{ needs.prepare.outputs.image_tag }} \
            --wait \
            --timeout $HELM_TIMEOUT
