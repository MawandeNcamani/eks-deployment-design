name: Create Dev Release

on:
  workflow_run:
    workflows: ["Deploy to Dev"]
    types: [ completed ]
    

jobs:
  release:
    if: >
      github.event.workflow_run.conclusion == 'success' &&
      github.event.workflow_run.head_branch == 'main'
    runs-on: ubuntu-latest
    permissions:
      contents: write
      actions: read
    
    steps:
      - uses: actions/checkout@v4
        with:
          ref: main
          fetch-depth: 0

      - name: Download deploy metadata artifact
        uses: dawidd6/action-download-artifact@v3
        with:
          workflow: deploy-dev.yml
          run_id: ${{ github.event.workflow_run.id }}
          name: deploy-metadata
          path: build-results

      - name: Read image ref
        id: meta
        shell: bash
        run: |
          IMAGE_REF=$(python -c "import json; print(json.load(open('build-results/deploy-metadata.json'))['imageRef'])")
          echo "image_ref=$IMAGE_REF" >> $GITHUB_OUTPUT

      - name: Create dev GitHub prerelease
        uses: softprops/action-gh-release@v2
        with:
          tag_name: dev-${{ github.event.workflow_run.run_number }}
          name: dev-${{ github.event.workflow_run.run_number }}
          prerelease: true
          generate_release_notes: true
          body: |
            Deployed to dev.

            Image: ${{ steps.meta.outputs.image_ref }}
            Workflow run: ${{ github.event.workflow_run.html_url }}
          files: |
            build-results/deploy-metadata.json
